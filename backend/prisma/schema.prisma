// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  output     = "../src/generated/prisma"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}


// -----------------------------------------------------------------------------
// User 
// -----------------------------------------------------------------------------

enum Role {
  ADMIN
  LANDLORD
  TENANT
}

model User {
  id           String @id @default(uuid()) 
  email        String @unique 
  passwordHash String 
  role         Role

  // Profile details
  firstName  String?
  middleName String?
  lastName   String?
  avatarUrl  String?
  birthdate  DateTime?
  gender     String?
  bio        String?

  // Contact info
  phoneNumber  String?
  messengerUrl String?
  facebookUrl  String?

  // Account status & security
  isVerified         Boolean   @default(false)
  isDisabled         Boolean   @default(false)
  lastPasswordChange DateTime?

  // Audit
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Onboarding
  hasSeenOnboarding Boolean @default(false)


  // Property Owned by the Landlord
  Property               Property[]
  MaintenanceRequest     MaintenanceRequest[]
  Notification           Notification[]
  UnitReview             UnitReview[]


  listingsAsLandlord     Listing[]                                              // landlord's listings
  listingsReviewed       Listing[]                @relation("ReviewedListings") // admin-reviewed listings

  // Lease relations
  tenantLeases   Lease[] @relation("TenantLeases")   // Leases where user is the tenant
  landlordLeases Lease[] @relation("LandlordLeases") // Leases where user is the landlord

  // Chat relationships
  tenantChannels   ChatChannel[] @relation("TenantChatChannels")
  landlordChannels ChatChannel[] @relation("LandlordChatChannels")

  // all the messages sent 
  sentMessages     ChatMessage[]

  // Units that this user currently occupies

  @@index([email])
  @@index([role])
  @@index([lastLogin])
  @@map("users")

  tenantScreening TenantScreening[] @relation("TenantScreeningsAsTenant")
  tenantScreeningLandlord TenantScreening[] @relation("TenantScreeningsAsLandlord")
  landlordOffenses LandlordOffense[]
}


// -----------------------------------------------------------------------------
// Amenity 
// -----------------------------------------------------------------------------
model Amenity {
  id       String @id @default(uuid())
  name     String @unique // e.g., "wifi", "pool", "aircon"
  category String // e.g., "Utility", "Facility", "Security"

  // Many-to-many relation with Unit
  units Unit[] @relation("UnitAmenities")
}

// -----------------------------------------------------------------------------
// City 
// -----------------------------------------------------------------------------
model City {
  id   String @id @default(uuid())
  name String @unique // e.g., "Cebu City", "Mandaue"

  properties Property[] // Properties located in this city
}

// -----------------------------------------------------------------------------
// Municipality
// -----------------------------------------------------------------------------
model Municipality {
  id         String     @id @default(uuid())
  name       String     @unique // e.g., "Toledo", "Danao"
  properties Property[] // Properties located in this municipality
}

// -----------------------------------------------------------------------------
// Property
// -----------------------------------------------------------------------------
model Property {
  id      String @id @default(uuid())
  ownerId String // FK to users.id (landlord)

  title     String // short human title for listing
  type      String // APARTMENT, CONDOMINUIM, BOARDING_HOUSE, SINGLE_HOUSE
  createdAt DateTime @default(now()) // audit created
  updatedAt DateTime @updatedAt // audit updated

  // --- Address ---
  street   String
  barangay String
  zipCode  String

  // Optional normalized locality references (one or none typically set)
  cityId String?
  city   City?   @relation(fields: [cityId], references: [id])

  municipalityId String?
  municipality   Municipality? @relation(fields: [municipalityId], references: [id])

  // --- Location for Google Maps ---
  latitude  Float? // optional geo coordinates
  longitude Float? // optional geo coordinates

  // --- Media & nearby institutions ---
  mainImageUrl     String // Featured image for the property
  // ["Education", "Healthcare", "Commerce", "Government", "Finance", "Transport", "Leisure", "Religion"]
  nearInstitutions Json? // JSON array of nearby institutions (format at app layer) { "name": "Ayala Mall", "type": "Mall" },

  otherInformation Json? // JSON array of other information format : { "context": "second Floor" : "description": "has a lot of information about the stuff and etc"}

  // --- Relations ---
  owner              User                 @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  Unit               Unit[]
  MaintenanceRequest MaintenanceRequest[]
  Transaction        Transaction[]

  @@unique([title, street, barangay, cityId, municipalityId])
  @@index([id])
  @@index([cityId])
  @@index([municipalityId])
  @@map("properties")
  Lease Lease[]
}

// -----------------------------------------------------------------------------
// Unit
// -----------------------------------------------------------------------------
model Unit {
  id         String @id @default(uuid())
  propertyId String // FK to properties.id

  // --- Basic Info ---
  label       String // human label (e.g., "Unit 3A")
  description String
  floorNumber Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // --- Layout & Features ---
  maxOccupancy   Int       @default(1)
  amenities      Amenity[] @relation("UnitAmenities")
  mainImageUrl   String? // main image of the unit
  otherImages    Json? // other images of the unit at 6 images

  // [ "general", "visitor", "payment", "maintenance", "safety", "noise", "pet", "cleaning", "parking", "other"]
  // format:   { "text": "No Black", "category": "general" }
  unitLeaseRules Json? // upto 10 rules and 7 words per rules limit

  // --- Pricing ---
  targetPrice     Float // cannot be more than a 100,000 and less  

  // --- Screening Settings ---
  requiresScreening Boolean @default(false) // true = landlord requires tenant screening


  // --- Physical Condition ---
  unitCondition  String  @default("GOOD") // GOOD, UNDER_MAINTENANCE, UNUSABLE

  // --- Relations ---
  property           Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  listings           Listing[]
  reviews            UnitReview[]
  MaintenanceRequest MaintenanceRequest[]
  Lease              Lease[]
  views              UnitView[]

  @@unique([propertyId, label])
  @@index([propertyId])
  @@map("units")
}

model UnitView {
  id        String   @id @default(uuid())
  unitId   String
  userId   String?  // Optional - stores user ID without relation (for analytics, not querying)
  
  // Just record when the view was qualified (after 15-20 sec)
  viewedAt DateTime @default(now())
  
  // Relations
  unit    Unit  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  @@index([unitId])
  @@index([viewedAt])
  @@index([unitId, viewedAt]) // For efficient monthly queries
  @@map("unit_views")
}

// -----------------------------------------------------------------------------
// Unit Review 
// -----------------------------------------------------------------------------
model UnitReview {
  id       String @id @default(uuid())
  tenantId String
  unitId   String

  rating    Int // 1 - 5
  comment   String?
  createdAt DateTime @default(now())

  tenant User @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit   Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([tenantId, unitId])
  @@map("unit_reviews")
}

// -----------------------------------------------------------------------------
// Listing
// -----------------------------------------------------------------------------
// Tracks listing lifecycle, AI moderation, sanitization actions, 
// recommendations, and payment details.
// -----------------------------------------------------------------------------
model Listing {
  id             String   @id @default(uuid())
  propertyId     String
  unitId         String
  landlordId     String

  
  // ---------------------------------------------------------------------------
  // Lifecycle
  // ---------------------------------------------------------------------------
  // Tracks the current stage of the listing.
  // Possible values for lifecycleStatus:
  //   - WAITING_REVIEW    → Payment complete, waiting admin review
  //   - VISIBLE           → Publicly visible (passed)
  //   - HIDDEN            → Temporarily hidden by landlord
  //   - EXPIRED           → Listing duration ended 
  //   - FLAGGED           → Found suspicious but and will be hidden
  //   - BLOCKED           → Fully removed or deactivated due to violations
  lifecycleStatus String   @default("WAITING_PAYMENT") 
  visibleAt       DateTime?
  hiddenAt        DateTime?
  expiresAt       DateTime?
  blockedAt       DateTime?
  reviewedAt      DateTime?
  flaggedAt       DateTime?

  // ---------------------------------------------------------------------------
  // Boosting
  // ---------------------------------------------------------------------------
  isFeatured Boolean @default(false)

  // ---------------------------------------------------------------------------
  // AI Moderation
  // ---------------------------------------------------------------------------


  // possible value for reason: "scam" | "fake_info" | "discriminatory" | "illegal" | "inappropriate" | "other"
  // action will always be remove 
  // just record what data was used
  propertySanitizeLogs Json? // [{ "part": "description", "reason": "inappropriate", "dataUsed": "...", "action": "..." }]
  unitSanitizeLogs     Json? // [{ "part": "leaseRules", "reason": "discriminatory", "dataUsed": "...", "action": "..." }]

  // --- Payment ---
  providerName   String?
  providerTxnId  String?
  paymentAmount  Float?
  paymentDate    DateTime?

  // ---------------------------------------------------------------------------
  // Review
  // ---------------------------------------------------------------------------
  // Records human (admin) reviews for listings that have passed AI checks.
  reviewedBy     String?
  flaggedReason  String?  // for admin
  blockedReason  String?  // for admin


  // reason should be the overall summary, exaample like scamming, the discriminatory and etc
  //  "type": "BLOCKED",         // e.g., "FLAGGED" | "BLOCKED" 
  resubmissionHistory Json? // [ { "attempt": 1,"type": "FLAGGED", "reason": "fake_info", "resubmittedAt": "2025-11-05T10:00:00Z",  },

  // --- Metadata ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relations ---
  unit      Unit  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  landlord  User  @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  reviewer  User? @relation("ReviewedListings", fields: [reviewedBy], references: [id])
  LandlordOffense LandlordOffense[]

  // --- Indexes ---
  @@index([unitId])
  @@index([landlordId])
  @@index([lifecycleStatus])
  @@index([isFeatured])
  @@index([reviewedBy])
  @@map("listings")
}

// -----------------------------------------------------------------------------
// LandlordOffense
// -----------------------------------------------------------------------------
// Audit trail of landlord misconduct linked to specific listings
// -----------------------------------------------------------------------------
model LandlordOffense {
  id             String   @id @default(uuid())
  landlordId     String
  listingId      String
  type           String   // "scam" | "fake_info" | "discriminatory" | "illegal" | "inappropriate" | "other"
  severity       String   // "LOW" | "MEDIUM" | "HIGH" 
  description    String?
  detectedBy     String?  // "AI" | "ADMIN" | "USER_REPORT"
  detectedAt     DateTime @default(now())

  // --- Metadata ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relations ---
  landlord User     @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  listing  Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([listingId])
  @@map("landlord_offenses")
}


// -----------------------------------------------------------------------------
// Lease 
// -----------------------------------------------------------------------------
model Lease {
  id          String   @id @default(uuid())
  propertyId  String    
  unitId      String
  tenantId    String
  landlordId  String

  // --- Basic Details ---
  leaseNickname   String?
  leaseType       String   @default("STANDARD") // STANDARD, SHORT_TERM, LONG_TERM, FIXED-TERM
  startDate       DateTime
  endDate         DateTime?
  rentAmount      Float

  // Optional one-time details
  securityDeposit Float?    // One-time amount held until lease ends

  interval        String    @default("MONTHLY") // DAILY, WEEKLY, MONTHLY
  dueDate         Int       // 1–28 (adjust if > daysInMonth)
  status          String    @default("PENDING") // PENDING, ACTIVE, COMPLETED, TERMINATED, CANCELLED

  // --- Digital Documents ---
  leaseDocumentUrl     String?

  // --- Landlord Notes (PRIVATE - tenant cannot see) ---
  // JSON array format: [{ "date": "2025-01-15T10:00:00Z", "note": "Tenant not cleaning regularly", "category": "CLEANLINESS" }]
  // Categories: "CLEANLINESS", "NOISE", "BEHAVIOR", "COMMUNICATION", "PROPERTY_DAMAGE", "OTHER"
  landlordNotes Json? // Landlord's private observations about tenant behavior

  // --- Timestamps ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  // --- Relations ---
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit      Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenant    User   @relation("TenantLeases", fields: [tenantId], references: [id], onDelete: Cascade)
  landlord  User   @relation("LandlordLeases", fields: [landlordId], references: [id], onDelete: Cascade)
  payments  Payment[]

  @@index([unitId])
  @@index([tenantId])
  @@index([startDate, endDate])
  @@map("leases")
}


// -----------------------------------------------------------------------------
// Payment
// -----------------------------------------------------------------------------
model Payment {
  id      String @id @default(uuid())
  leaseId String

  amount        Float
  paidAt        DateTime?
  dueDate         DateTime   // when this payment is due (use for reminders)
  method        String?  // CASH, GCASH, PAYPAL, etc.
  note String?      // Notes from landlord 
  
  
  // --- Tracking ---
  status        String @default("PENDING")  // PENDING, PAID
  timingStatus  String?                     // ONTIME, LATE, ADVANCE
  type String? // "RENT", "ADVANCE PAYMENT", "PREPAYMENT", "PENALTY", "ADJUSTMENT"
  reminderStage Int     @default(0)         // 0=none, 1=pre-due (2 days before the due date), 2=due-day 
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@index([leaseId])
  @@index([paidAt])
  @@map("payments")
}


// -----------------------------------------------------------------------------
// Tenant Screening
// -----------------------------------------------------------------------------
model TenantScreening {
  id          String   @id @default(uuid())
  tenantId    String
  landlordId  String

  // ============================================================
  // REVIEW STATUS — Managed by system and landlord
  // ============================================================
  status      String   @default("PENDING") // PENDING | SUBMITTED | APPROVED | REJECTED 
  remarks     String?                      // System-generated note (e.g., "You do not qualify at this time")

  // ============================================================
  // BASIC INFO — Collected from tenant application form
  // ============================================================
  fullName         String
  birthdate        DateTime?
  employmentStatus String?  // STUDENT | EMPLOYED | SELF_EMPLOYED | UNEMPLOYED
  incomeSource     String?  // e.g. Salary, Business, Allowance
  monthlyIncome    Float?

  // ============================================================
  // DOCUMENT & IDENTITY CHECKS — Tenant confirms availability
  // (Landlord may verify in person later for privacy)
  // ============================================================
  hasGovernmentId  Boolean? @default(false) // Valid government-issued ID
  hasNbiClearance  Boolean? @default(false) // Criminal background clearance
  hasProofOfIncome Boolean? @default(false) // Payslip, remittance, or bank proof

  // ============================================================
  // FINANCIAL & EMPLOYMENT HISTORY
  // ============================================================
  currentEmployer     String? // Optional — Name of employer or company
  jobPosition         String? // Optional — Current role or position
  yearsEmployed       Int?    // Optional — How long have they been employed
  employmentRemarks   String? // Optional — Additional details about work or income consistency

  // ============================================================
  // RENTAL HISTORY — Used to assess reliability as a tenant
  // ============================================================
  previousLandlordName    String? // Optional
  previousLandlordContact String? // Optional (phone or email)
  previousRentalAddress   String? // Optional
  reasonForLeaving        String? // Optional — Why they left previous unit
  hadEvictionHistory      Boolean? @default(false) // If ever evicted before
  latePaymentHistory      Boolean? @default(false) // History of delayed rent payments

  // ============================================================
  // LIFESTYLE INDICATORS — Used to assess property compatibility
  // ============================================================
  smokes          Boolean? @default(false)
  drinksAlcohol   Boolean? @default(false)
  hasPets         Boolean? @default(false)
  worksNightShift Boolean? @default(false)
  hasVisitors     Boolean? @default(false)
  noiseLevel      String?  // LOW | MODERATE | HIGH
  otherLifestyle  String[] // e.g. ["Gamer", "Travels Often", "Works from Home"]

  // ============================================================
  // AI ANALYSIS — System generated after submission
  // ============================================================
  aiRiskScore        Float?  // 0.0 - 1.0
  riskLevel          String? // LOW | MEDIUM | HIGH
  aiScreeningSummary String? // Short readable result
  // possible value in : ai findings: financial | employment | identity_verification | documents | rental_history | eviction_risk | payment_behavior | lifestyle | behavior | overall
  aiFindings         Json?   // Deep reasoning (e.g., {"financial": "...", "behavior": "..."})
  aiGeneratedAt      DateTime?

  // ============================================================
  // METADATA
  // ============================================================
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  submitted   DateTime?
  reviewedAt  DateTime?

  // ============================================================
  // RELATIONS
  // ============================================================
  tenant   User @relation("TenantScreeningsAsTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  landlord User @relation("TenantScreeningsAsLandlord", fields: [landlordId], references: [id], onDelete: Cascade)

  @@map("tenant_screenings")
}


// -----------------------------------------------------------------------------
// Maintenance
// -----------------------------------------------------------------------------
model MaintenanceRequest {
  // Identity & description
  id          String @id @default(uuid())
  propertyId  String
  unitId      String
  reporterId  String
  description String
  photoUrl    String

  // Priority & status
  status String // OPEN, IN_PROGRESS, RESOLVED, CANCELLED, INVALID

  // Auditing
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (cascade to cleanup when property/unit/user removed)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit     Unit?    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  reporter User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@map("maintenance_requests")
}

// -----------------------------------------------------------------------------
// Transaction (Income & Expense combined)
// -----------------------------------------------------------------------------
model Transaction {
  // Combined income and expense records per property (for simple bookkeeping & reports)
  id          String   @id @default(uuid())
  propertyId  String // FK → Property.id
  unitId      String? // optional → null means "property-level transaction"
  amount      Float
  description String // e.g. "rent", "late fee", "maintenance", "repairs"
  date        DateTime @default(now())

  // --- Transaction Type ---
  type String // "INCOME" or "EXPENSE"

  // --- Categorization & Tracking ---
  // For INCOME: RENT, LATE_FEE, DEPOSIT, OTHER_INCOME, etc.
  // For EXPENSE: MAINTENANCE, REPAIRS, UTILITIES, INSURANCE, TAXES, PROPERTY_MANAGEMENT, LISTING_ADVERTISING, OTHER_EXPENSE, etc.
  category String?
  
  // --- Recurring Transaction ---
  // If recurringInterval is not null, then it is recurring
  recurringInterval String? // MONTHLY, WEEKLY, YEARLY (null if not recurring)
  
  // --- Audit ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relations ---
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([date])
  @@index([type])
  @@index([category])
  @@map("transactions")
}

// -----------------------------------------------------------------------------
// Notification
// -----------------------------------------------------------------------------
model Notification {
  id      String  @id @default(uuid())
  userId  String
  type    String? // "PAYMENT", "LEASE", "SYSTEM" (free text, no enum restriction)
  message String

  // --- Status tracking ---
  status String    @default("UNREAD") // UNREAD, READ, ARCHIVED
  readAt DateTime? // when the user opened it

  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("notifications")
}

// -----------------------------------------------------------------------------
// Chat
// -----------------------------------------------------------------------------
model ChatChannel {
  id          String   @id @default(uuid())
  tenantId    String
  landlordId  String
  status      String   @default("INQUIRY") // INQUIRY, ACTIVE, ENDED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // --- Chat summary fields ---
  lastMessageText     String?   // ✅ snapshot of the last message
  lastMessageAt       DateTime? // ✅ when last message was sent
  lastMessageSenderId String?   // ✅ who sent the last message
  readAt              DateTime? // ✅ when last message was read 

  // --- Relations ---
  tenant   User @relation("TenantChatChannels", fields: [tenantId], references: [id])
  landlord User @relation("LandlordChatChannels", fields: [landlordId], references: [id])
  messages ChatMessage[]

  @@unique([tenantId, landlordId])
  @@map("chat_channels")
}

// -----------------------------------------------------------------------------
// Chat Messages
// -----------------------------------------------------------------------------
model ChatMessage {
  id        String   @id @default(uuid())
  channelId String
  senderId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  readAt    DateTime?

  // --- Relations ---
  channel ChatChannel @relation(fields: [channelId], references: [id])
  sender  User        @relation(fields: [senderId], references: [id])

  @@index([channelId])
  @@map("chat_messages")
}


