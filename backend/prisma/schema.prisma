// ============================================================================
// Prisma schema — organized + annotated
// ============================================================================

// -----------------------------------------------------------------------------
// GENERATOR & DATASOURCE
// -----------------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Used by Prisma Client at runtime
  directUrl = env("DIRECT_URL") // Used for migrations and introspection
}

// ============================================================================
// ENUM DEFINITIONS
// ============================================================================

// --------------------
// USER enums
// --------------------
// Role used to gate UI & permissions (admin, landlord, tenant)
// Possible values: ADMIN, LANDLORD, TENANT
enum Role {
  ADMIN
  LANDLORD
  TENANT
}

// ============================================================================
// MODELS
// ============================================================================ 
// --------------------
// USER: primary account table (auth + role + profile + contacts)
// --------------------
model User {
  id           String @id @default(uuid()) // PK: UUID
  email        String @unique // login credential
  passwordHash String // store only hashed pw
  role         Role

  // Profile details
  firstName  String?
  middleName String?
  lastName   String?
  avatarUrl  String?
  birthdate  DateTime?
  gender     String?
  bio        String?

  // Contact info
  phoneNumber  String? // normalized format
  messengerUrl String?
  facebookUrl  String?
  whatsappUrl  String?

  // Account status & security
  isVerified         Boolean   @default(false)
  isDisabled         Boolean   @default(false)
  lastPasswordChange DateTime?

  // Audit
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Onboarding
  hasSeenOnboarding Boolean @default(false)

  // Relations (user roles/actions)
  Property               Property[]
  MaintenanceRequest     MaintenanceRequest[]
  Notification           Notification[]
  UnitReview             UnitReview[]

  listingsAsLandlord     Listing[]                                              // landlord’s listings
  listingsReviewed       Listing[]                @relation("ReviewedListings") // admin-reviewed listings
  TenantBehaviorAnalysis TenantBehaviorAnalysis[]
  TenantChatbotSession   TenantChatbotSession[]

  // Lease relations
  tenantLeases   Lease[] @relation("TenantLeases")   // Leases where user is the tenant
  landlordLeases Lease[] @relation("LandlordLeases") // Leases where user is the landlord

  // Chat relationships
  tenantChannels   ChatChannel[] @relation("TenantChatChannels")
  landlordChannels ChatChannel[] @relation("LandlordChatChannels")

  // all the messages sent 
  sentMessages     ChatMessage[]

  @@index([email])
  @@index([role])
  @@index([lastLogin])
  @@map("users")

  tenantScreening TenantScreening[] @relation("TenantScreeningsAsTenant")
  tenantScreeningLandlord TenantScreening[] @relation("TenantScreeningsAsLandlord")
}

// --------------------
// Amenity & Location (lookup) Models
// --------------------
// Amenity: seed this table (e.g., wifi, pool, aircon) during migrations
model Amenity {
  id       String @id @default(uuid())
  name     String @unique // e.g., "wifi", "pool", "aircon"
  category String // e.g., "Utility", "Facility", "Security"

  // Many-to-many relation with Unit
  units Unit[] @relation("UnitAmenities")
}

// City-level lookup for normalization
model City {
  id   String @id @default(uuid())
  name String @unique // e.g., "Cebu City", "Mandaue"

  properties Property[] // Properties located in this city
}

// Municipality-level lookup
model Municipality {
  id         String     @id @default(uuid())
  name       String     @unique // e.g., "Toledo", "Danao"
  properties Property[] // Properties located in this municipality
}

// --------------------
// PROPERTY
// --------------------
// Property: a landlord-owned location that contains Units.
// Address fields intentionally split (city OR municipality optional).
model Property {
  id      String @id @default(uuid())
  ownerId String // FK to users.id (landlord)

  title     String // short human title for listing
  type      String // APARTMENT, CONDOMINUIM, BOARDING_HOUSE, SINGLE_HOUSE
  createdAt DateTime @default(now()) // audit created
  updatedAt DateTime @updatedAt // audit updated

  // --- Address ---
  street   String
  barangay String
  zipCode  String

  // Optional normalized locality references (one or none typically set)
  cityId String?
  city   City?   @relation(fields: [cityId], references: [id])

  municipalityId String?
  municipality   Municipality? @relation(fields: [municipalityId], references: [id])

  // --- Location for Google Maps ---
  latitude  Float? // optional geo coordinates
  longitude Float? // optional geo coordinates

  // --- Media & nearby institutions ---
  mainImageUrl     String // Featured image for the property
  nearInstitutions Json? // JSON array of nearby institutions (format at app layer) { "name": "Ayala Mall", "type": "Mall" },

  // other information || update the schema first to reflect new changes
  // otherInformation Json? // JSON array of other information format : { "context": "second Floor" : "description": "has a lot of information about the stuff and etc"}

  // --- Relations ---
  owner              User                 @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  Unit               Unit[]
  MaintenanceRequest MaintenanceRequest[]
  Income             Income[]
  Expense            Expense[]

  @@unique([title, street, barangay, cityId, municipalityId])
  @@index([id])
  @@index([cityId])
  @@index([municipalityId])
  @@map("properties")
  Lease Lease[]
}

// --------------------
// UNIT
// --------------------
// Unit: rentable sub-space within a Property (room, apartment, etc.)
model Unit {
  id         String @id @default(uuid())
  propertyId String // FK to properties.id

  // --- Basic Info ---
  label       String // human label (e.g., "Unit 3A")
  description String
  status      String // AVAILABLE, OCCUPIED, MAINTENANCE
  floorNumber Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // --- Layout & Features ---
  maxOccupancy   Int       @default(1)
  amenities      Amenity[] @relation("UnitAmenities")
  mainImageUrl   String? // main image of the unit
  otherImages    Json? // other images of the unit at 6 images
  unitLeaseRules Json? // upto 10 rules and 7 words per rules limit
  viewCount      Int       @default(0)

  // --- Pricing ---
  targetPrice     Float // cannot be more than a 100,000 and less  
  securityDeposit Float? // ----------------------------------------------------- || to be removed

  // --- Screening Settings ---
  requiresScreening Boolean @default(false) // true = landlord requires tenant screening

  // --- Listing Status
  listedAt DateTime? // null = not listed, timestamp = listed date

  // --- Relations ---
  property           Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  listings           Listing[]
  reviews            UnitReview[]
  MaintenanceRequest MaintenanceRequest[]
  Lease              Lease[]

  @@unique([propertyId, label])
  @@index([propertyId])
  @@map("units")
  ChatChannel ChatChannel[]
}

// --------------------
// UNIT REVIEW
// --------------------
model UnitReview {
  id       String @id @default(uuid())
  tenantId String
  unitId   String

  rating    Int // 1 - 5
  comment   String?
  createdAt DateTime @default(now())

  tenant User @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit   Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([tenantId, unitId])
  @@map("unit_reviews")
}

// --------------------
// LISTING
// --------------------
model Listing {
  id             String    @id @default(uuid())
  propertyId     String
  unitId         String
  landlordId     String
  reviewedBy     String?
  lastReviewedAt DateTime?

  // --- Lifecycle ---
  lifecycleStatus String    @default("WAITING_PAYMENT") // || visible and hidden means property is listed
  // WAITING_PAYMENT → VISIBLE → HIDDEN → EXPIRED → BLOCKED
  expiresAt       DateTime?
  isFeatured      Boolean   @default(false)

  // --- AI Analysis Snapshot ---
  riskLevel  String? // "LOW" | "MEDIUM" | "HIGH"
  riskReason String? // e.g. "Duplicate photos found"

  aiAnalysis        Json? // e.g. [{ "part": "price", "description": "Target price is above market range" }]
  aiRecommendations Json? // e.g. [{ "part": "images", "suggestion": "Upload at least 2 more photos" }]

  // --- Payment Info ---
  providerName  String? // "GCASH" | "MAYA" 
  providerTxnId String? // PayMongo transaction or checkout ID
  paymentAmount Float? // store in pesos (₱100.00)
  paymentDate   DateTime?
  payerPhone    String?

  // --- Admin Review --- IF BLOCK
  blockedAt     DateTime? // when admin blocked it
  blockedReason String?

  // --- Metadata ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relations ---
  unit     Unit  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  landlord User  @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  reviewer User? @relation("ReviewedListings", fields: [reviewedBy], references: [id])

  @@index([unitId])
  @@index([landlordId])
  @@index([isFeatured])
  @@index([reviewedBy])
  @@map("listings")
}

model Lease {
  id          String   @id @default(uuid())
  propertyId  String    
  unitId      String
  tenantId    String
  landlordId  String

  // --- Basic Details ---
  leaseNickname   String?
  leaseType       String   @default("STANDARD") // STANDARD, SHORT_TERM, LONG_TERM, FIXED-TERM
  startDate       DateTime
  endDate         DateTime?
  rentAmount      Float

  // Optional one-time details
  securityDeposit Float?    // One-time amount held until lease ends
  advanceMonths   Int       @default(0)         // How many months prepaid rent

  interval        String    @default("MONTHLY") // DAILY, WEEKLY, MONTHLY
  dueDate         Int       // 1–31 (adjust if > daysInMonth)
  status          String    @default("PENDING") // PENDING, ACTIVE, COMPLETED, TERMINATED, CANCELLED


  // --- Tracking ---
  totalPaymentsMade Int      @default(0)   // Incremented when tenant pays
  lastPaymentDate   DateTime?              // Useful for reminders

  // --- Digital Documents ---
  leaseDocumentUrl     String?
  landlordSignatureUrl String?
  tenantSignatureUrl   String?

  // --- Timestamps ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  // --- Relations ---
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit      Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenant    User   @relation("TenantLeases", fields: [tenantId], references: [id], onDelete: Cascade)
  landlord  User   @relation("LandlordLeases", fields: [landlordId], references: [id], onDelete: Cascade)
  payments  Payment[]
  behaviors TenantBehaviorAnalysis[]

  @@index([unitId])
  @@index([tenantId])
  @@index([startDate, endDate])
  @@map("leases")
}


// --------------------
// PAYMENT: actual transactions
// --------------------
model Payment {
  id      String @id @default(uuid())
  leaseId String

  amount        Float
  paidAt        DateTime?
  method        String?  // CASH, GCASH, PAYPAL, etc.
  paymentProofUrl String?


  // --- Tracking ---
  status        String @default("PENDING")  // PENDING, PAID
  timingStatus  String?                     // ONTIME, LATE, ADVANCE
  note          String?
  reminderStage Int     @default(0)         // 0=none, 1=pre-due, 2=due-day, 3=late notice sent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@index([leaseId])
  @@index([paidAt])
  @@map("payments")
}


model TenantScreening {
  id          String   @id @default(uuid())
  tenantId    String
  landlordId  String

  // ============================================================
  // REVIEW STATUS — Managed by system and landlord
  // ============================================================
  status      String   @default("PENDING") // PENDING | SUBMITTED | APPROVED | REJECTED
  remarks     String?                      // System-generated note (e.g., "You do not qualify at this time")
  reviewedAt  DateTime?

  // ============================================================
  // BASIC INFO — Collected from tenant application form
  // ============================================================
  fullName         String
  birthdate        DateTime?
  employmentStatus String?  // STUDENT | EMPLOYED | SELF_EMPLOYED | UNEMPLOYED
  incomeSource     String?  // e.g. Salary, Business, Allowance
  monthlyIncome    Float?

  // ============================================================
  // DOCUMENT & IDENTITY CHECKS — Tenant confirms availability
  // (Landlord may verify in person later for privacy)
  // ============================================================
  hasGovernmentId  Boolean? @default(false) // Valid government-issued ID
  hasNbiClearance  Boolean? @default(false) // Criminal background clearance
  hasProofOfIncome Boolean? @default(false) // Payslip, remittance, or bank proof

  // ============================================================
  // FINANCIAL & EMPLOYMENT HISTORY
  // ============================================================
  currentEmployer     String? // Optional — Name of employer or company
  jobPosition         String? // Optional — Current role or position
  yearsEmployed       Int?    // Optional — How long have they been employed
  employmentRemarks   String? // Optional — Additional details about work or income consistency

  // ============================================================
  // RENTAL HISTORY — Used to assess reliability as a tenant
  // ============================================================
  previousLandlordName    String? // Optional
  previousLandlordContact String? // Optional (phone or email)
  previousRentalAddress   String? // Optional
  reasonForLeaving        String? // Optional — Why they left previous unit
  hadEvictionHistory      Boolean? @default(false) // If ever evicted before
  latePaymentHistory      Boolean? @default(false) // History of delayed rent payments

  // ============================================================
  // LIFESTYLE INDICATORS — Used to assess property compatibility
  // ============================================================
  smokes          Boolean? @default(false)
  drinksAlcohol   Boolean? @default(false)
  hasPets         Boolean? @default(false)
  worksNightShift Boolean? @default(false)
  hasVisitors     Boolean? @default(false)
  noiseLevel      String?  // LOW | MODERATE | HIGH
  otherLifestyle  String[] // e.g. ["Gamer", "Travels Often", "Works from Home"]

  // ============================================================
  // AI ANALYSIS — System generated after submission
  // ============================================================
  aiRiskScore        Float?  // 0.0 - 1.0
  riskLevel          String? // LOW | MEDIUM | HIGH
  aiScreeningSummary String? // Short readable result
  aiFindings         Json?   // Deep reasoning (e.g., {"financial": "...", "behavior": "..."})
  aiGeneratedAt      DateTime?

  // ============================================================
  // METADATA
  // ============================================================
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================================
  // RELATIONS
  // ============================================================
  tenant   User @relation("TenantScreeningsAsTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  landlord User @relation("TenantScreeningsAsLandlord", fields: [landlordId], references: [id], onDelete: Cascade)

  @@map("tenant_screenings")
}


// --------------------
// LEASE DOCUMENT (Legal Contract / PDF Export)
// --------------------
// External from core Lease/Payment system
// Acts as a snapshot of agreement terms
model LeaseDocument {
  id String @id @default(uuid())

  // Optional reference IDs (plain strings only)
  propertyId String?
  unitId     String?

  // Nickname or label for quick lookup
  leaseNickname String?

  // --------------------
  // Lease Information
  // --------------------
  startDate     DateTime?
  endDate       DateTime?
  endBehavior   String? // "RENEW_MONTH_TO_MONTH" | "TERMINATE_ON_END_DATE" | "OTHER"
  leaseTermType String? // "FIXED" | "MONTH_TO_MONTH" | "SHORT_TERM" | "LONG_TERM"

  // --------------------
  // Address & Room Info
  // --------------------
  addressStreet       String?
  addressBarangay     String?
  addressZipCode      String?
  addressCity         String?
  addressMunicipality String?
  roomDescription     String? @db.Text

  // --------------------
  // Rent & Deposit
  // --------------------
  monthlyRent                Float?
  securityDepositAmount      Float?
  securityDepositMonths      Int?
  allowableDepositDeductions String? @db.Text
  depositHeldAtName          String?
  depositHeldAtAddress       String?
  oneTimeFees                Json?
  paymentAccepted            Json?

  // --------------------
  // Parties
  // --------------------
  tenantFirstName     String?
  tenantLastName      String?
  tenantEmail         String?
  tenantPhone         String?
  additionalOccupants Json?

  landlordFirstName      String?
  landlordLastName       String?
  landlordMailingAddress String? @db.Text

  // --------------------
  // Rules & Policies
  // --------------------
  petAllowed         Boolean @default(false)
  petTypes           String? @db.Text
  smokingPolicy      String? // "YES" | "NO" | "OUTSIDE_ONLY"
  parkingIncluded    Boolean @default(false)
  parkingDescription String? @db.Text

  utilitiesResponsibilities Json?
  sharedUtilitiesNote       String? @db.Text
  keysProvided              Json?
  lostKeyPolicy             String? @db.Text
  maintenanceNote           String? @db.Text
  earlyTerminationAllowed   Boolean @default(false)
  additionalTerms           String? @db.Text

  // --------------------
  // Condition Report
  // --------------------
  conditionReportName   String?
  conditionReportType   String? // "MOVE_IN" | "MOVE_OUT" | "OTHER"
  conditionReportDate   DateTime?
  conditionReportSpaces Json?
  conditionReportItems  Json?

  // --------------------
  // Home Guide
  // --------------------
  homeGuideWelcomeNote     String? @db.Text
  homeGuideWelcomeImageUrl String?
  homeGuideAccessSecurity  String? @db.Text
  homeGuideHouseRules      String? @db.Text
  homeGuideCommunication   String? @db.Text
  homeGuideLeaseInfo       String? @db.Text

  // --------------------
  // PDF Metadata
  // --------------------
  pdfUrl      String?
  version     Int? // for legal revisions
  generatedBy String?
  generatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([unitId])
  @@map("lease_documents")
}

// --------------------
// Maintenance Models
// --------------------
// MaintenanceRequest: repairs & issues reported by tenants/landlords
model MaintenanceRequest {
  // Identity & description
  id          String @id @default(uuid())
  propertyId  String
  unitId      String
  reporterId  String
  description String
  photoUrl    String

  // Priority & status
  status String // OPEN, IN_PROGRESS, RESOLVED

  // Auditing
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (cascade to cleanup when property/unit/user removed)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit     Unit?    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  reporter User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@map("maintenance_requests")
}

// --------------------
// Income / Expense (simple bookkeeping)
// --------------------
model Income {
  // Income record per property (for simple bookkeeping & reports)
  id          String   @id @default(uuid())
  propertyId  String // FK → Property.id
  unitId      String? // optional → null means "property-level income"
  amount      Float
  description String // e.g. “rent”, “late fee”
  date        DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("incomes")
}

model Expense {
  // Expense record per property (simple bookkeeping)
  id          String   @id @default(uuid())
  propertyId  String
  unitId      String? // optional → null means "property-level expense"
  amount      Float
  description String
  date        DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("expenses")
}

// --------------------
// Notifications
// --------------------
// Notification: lightweight inbox messages for users (store message body)
model Notification {
  id      String  @id @default(uuid())
  userId  String
  type    String? // "PAYMENT", "LEASE", "SYSTEM" (free text, no enum restriction)
  message String

  // --- Status tracking ---
  status String    @default("UNREAD") // UNREAD, READ, ARCHIVED
  readAt DateTime? // when the user opened it

  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("notifications")
}

// ============================================================================
// CHAT CHANNEL
// ============================================================================
model ChatChannel {
  id          String   @id @default(uuid())
  tenantId    String
  landlordId  String
  unitId      String
  status      String   @default("INQUIRY") // INQUIRY, ACTIVE, ENDED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // --- Chat summary fields ---
  lastMessageText     String?   // ✅ snapshot of the last message
  lastMessageAt       DateTime? // ✅ when last message was sent
  lastMessageSenderId String?   // ✅ who sent the last message
  readAt              DateTime? // ✅ when last message was read 

  // --- Relations ---
  tenant   User @relation("TenantChatChannels", fields: [tenantId], references: [id])
  landlord User @relation("LandlordChatChannels", fields: [landlordId], references: [id])
  unit     Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@unique([tenantId, landlordId, unitId])
  @@map("chat_channels")
}

// ============================================================================
// CHAT MESSAGE
// ============================================================================

model ChatMessage {
  id        String   @id @default(uuid())
  channelId String
  senderId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  readAt    DateTime?

  // --- Relations ---
  channel ChatChannel @relation(fields: [channelId], references: [id])
  sender  User        @relation(fields: [senderId], references: [id])

  @@index([channelId])
  @@map("chat_messages")
}


// --------------------
// Tenant Behavior Analysis
// --------------------
model TenantBehaviorAnalysis {
  id String @id @default(uuid())

  tenantId String // FK to User
  leaseId  String // FK to Lease (required, ensures visibility control)

  // --------------------
  // Screening Snapshot (at start of lease)
  // --------------------
  screeningRiskLevel String? // e.g., "LOW", "MEDIUM", "HIGH"
  aiScreeningSummary String? @db.Text // snapshot of TenantScreening.aiScreeningSummary

  // --------------------
  // Core Behavior Metrics
  // --------------------
  paymentBehavior    String? // "ONTIME", "LATE", "ADVANCE", "MIXED"
  paymentReliability Float? // % of on-time payments (0.0 → 1.0)

  maintenanceRequestsCount Int     @default(0)
  maintenanceRiskLevel     String? // "LOW", "MEDIUM", "HIGH"

  hasFrequentComplaints Boolean? @default(false)
  complaintNotes        String?  @db.Text

  // --------------------
  // AI Evaluation (post-lease behavior analysis)
  // --------------------
  aiRiskScore Float? // 0.0 → 1.0
  riskLevel   String? // "LOW", "MEDIUM", "HIGH"
  aiSummary   String? @db.Text // "Tenant usually pays late but keeps unit clean"
  aiCategory  String? // "Reliable", "Risky", "Irresponsible", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --------------------
  // Relations
  // --------------------
  tenant User  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lease  Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([leaseId])
  @@map("tenant_behavior_analysis")
}

// 
// --------------------
// Tenant Chatbot Session
// --------------------
// Stores AI session per tenant, deleted on logout
model TenantChatbotSession {
  id        String   @id @default(uuid())
  tenantId  String
  context   Json // stores collected info like city, municipality, amenities, etc.
  messages  Json // array of messages: [{sender: "tenant" | "ai", text: "..."}]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant User @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_chatbot_sessions")
}
